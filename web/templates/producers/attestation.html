{% extends "producers/index.html" %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.css"/>
{% endblock %}


{% block producer  %}
<div class="main" style="overflow-x: auto;">
	<div class="panel">
		<h3>Attestation de Durabilité {{current_attestation.period}}</h3>
		<div class="button-container">
			<div class="button-item">
				<a class="button modal-button" id="btn_modal_import">Importer</a>
				<div class="modal__backdrop" id="modal_import">
					<div class="modal">
						<a href="/static/files/template.csv">Modèle</a>
						<input type="file" id="file_to_upload">
						<div class="form__group button__group">
							<a class="button secondary close" href="#">Annuler</a>
						</div>
					</div>
				</div>
			</div>
			<div class="button-item button-push" style="margin-top: 30px;">
				<a id="btn_modal_columns"><small>Colonnes</small></a>
				<div class="modal__backdrop" id="modal_columns">
					<div class="modal">
						<table id="table_columns_filter">
							<!-- dynamically generated in js -->
						</table>
						<div class="form__group button__group">
							<a class="button secondary close">Ok</a>
						</div>
					</div>
				</div>
			</div>
		</div>	
		<table class="display nowrap" id="datatable">
			<!-- dynamically generated in js -->
			<thead></thead>
			<tfoot></tfoot>
			<tbody></tbody>
		</table>
		<div class="flex-container-right">
			<select id="select_affiliate">
			 	<option value="none">--</option>
			  	<option value="total">Total</option>
			  	<option value="OperateurGamma">OperateurGamma</option>
			  	<option value="petrobras">Petrobras</option>
			  	<option value="bp">BP</option>
			  	<option value="repsol">Repsol</option>
			  	<option value="export">Export</option>
			</select>
			<a id="btn_affiliate" class="button primary" href="#">Affilier Lots</a>
			<a id="btn_validate" class="button primary" href="#">Valider Lots</a>
			<a id="btn_delete" class="button primary" href="#">Supprimer Lots</a>
		</div>
		<div class="flex-container-left">
			<a class="button primary "id="add_lot">Ajouter Lot</a>
			<a id="add_lot_params" style="margin-top: auto;"><small>Paramètres</small></a>
		</div>		
	    <div class="form__group" id="add_lot_params_toggle" style="display: none;">
	      <fieldset>
	      <legend><small>Sélectionnez les valeurs à dupliquer lors de l'ajout de lot</small></legend>
	      <ul class="flex-container-a" id="list_columns_filter">
	      	<!-- dynamically generated in js -->
	      </ul>
	      </fieldset>
  		</div>       		
	</div>
</div>

<div class="modal__backdrop" id="modal_lot">
	<div class="modal modal-big">
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Informations Générales</h2>
					<label for="ml_depot">Dépôt</label>
					<input type="text" value="" id="ml_depot">
					<label for="ml_dae">N°DAE ou DAA</label>
					<input type="text" value="" id="ml_dae">
					<label for="ml_volume">Volume</label>
					<input type="text" value="" id="ml_volume">
					<label for="ml_date_entree">Date d'entrée en EFS ou UER</label>
					<input type="text" value="" id="ml_date_entree">
					<label for="ml_pays">Pays d'implantation</label>
					<input type="text" value="" id="ml_pays">
					<label for="ml_date_mise_en_service">Date de mise en service</label>
					<input type="text" value="" id="ml_date_mise_en_service">
				</div>
			</div>
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Durabilité</h2>
					<label for="ml_filiere">Filière de production</label>
					<select id="ml_filiere">
						<option>Choisissez...</option>
						<option>Colza</option>
						<option>Maïs</option>
						<option>Navet</option>
						<option>Fenouil</option>
					</select>
					<label for="ml_type">Types</label>
					<input type="text" value="" id="ml_type">
					<label for="ml_cat">Catégorie</label>
					<input type="text" value="" id="ml_cat">
					<label for="ml_systeme_fournisseur">Système fournisseur</label>
					<input type="text" value="" id="ml_systeme_fournisseur">
					<label for="ml_pays_origine">Pays d'origine</label>
					<input type="text" value="" id="ml_pays_origine">
					<label for="ml_respect_crit_durabilite">Respect des critères de durabilité</label>
					<input type="text" value="" id="ml_respect_crit_durabilite">
					<label for="ml_num_double_comptage">Éligible double-comptage</label>
					<input type="text" value="" id="ml_num_double_comptage">
				</div>
			</div>
		</section>
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Émissions GES</h2>
					<table>
						<thead>
							<th>GES transport et distribution</th>
							<th>Total émissions de GES</th>
							<th>GES du carburant fossile</th>
							<th>% de réduction totale</th>
						</thead>
						<tbody>
							<td><input type="text" id="ml_ges_transport_distribution" /></td>
							<td><input type="text" id="ml_ges_total" /></td>
							<td><input type="text" id="ml_ges_fossile" /></td>
							<td><input type="text" id="ml_ges_reduction" /></td>
						</tbody>
					</table>
				</div>
			</div>
		</section>
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Affiliation</h2>
					<table>
						<thead>
							<th>Date</th>
							<th>Vendeur</th>
							<th>Client</th>
						</thead>
						<tbody>
							<td><input type="text" id="ml_date_affiliation" value="27/01/2020"/></td>
							<td><input type="text" id="ml_vendeur" value="BioRaffinerie Lambda"/></td>
							<td><input type="text" id="ml_client" value="OperateurGamma"/></td>
						</tbody>
					</table>
				</div>
			</div>
		</section>		
		<section class="flex-container-right">
			<div class="form__group button__group">
				<a class="button primary close" href="#">Valider</a>
				<a class="button primary close" href="#">Sauvegarder</a>
				<a class="button secondary close" href="#">Annuler</a>
			</div>
		</section>
	</div>
</div>

{% endblock %}


{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.js"></script>
<script type="text/javascript">
var table_columns = [{title:'N°DAE', can_hide: true, can_duplicate: false, data:'num_dae'}, {title: 'Volume', can_hide: true, can_duplicate: true, data: 'volume'}, {title:'Type', can_hide: true, can_duplicate: true, can_filter: true, data: 'type'}, {title:'Matière Première', can_hide: true, can_duplicate: true, can_filter: true, data: 'matiere_premiere'}, {title:`Pays d'origine`, can_hide: true, can_duplicate: true, can_filter: true, data: 'pays_origine'}, {title:'GES Tranport et Distribution', can_hide: true, can_duplicate: true, data: 'ges_transport_distribution'}, {title:'GES Fossile', can_hide: true, can_duplicate: true, data: 'ges_fossile'}, {title:'% de réduction', can_hide: true, can_duplicate: true, read_only: true, data: 'ges_reductions'}, {title:`Pays d'implantation`, can_hide: true, can_duplicate: true, can_filter: true, data:'pays_implantation'}, {title:'Date de mise en service', can_hide: true, can_duplicate: true, can_filter: true, data: 'date_mise_en_service'}, {title:'Statut', can_hide: true, can_duplicate: true, read_only: true, can_filter: true, data: 'statut'}, {title:'Client', can_hide: true, can_duplicate: true, can_filter: true, data:'client'}, {title:`<input type="checkbox" id="checkbox_header"/>`, can_hide: false, can_duplicate: false, read_only: true, data:'checkbox'}]

var selected_rows = {}

$(document).ready(function() {
	function initFilters() {
		var table_columns_filter = $("#table_columns_filter")
		var list_columns_filter = $("#list_columns_filter")
		var columns_filter_html = ""
		var list_columns_filter_html = ""
		for (let i = 0, len = table_columns.length; i < len; i++) {
			let column = table_columns[i]
			if (column.can_hide === true) {
				columns_filter_html += `<tr><td><input type="checkbox" id="checkbox${i}" class="toggle-vis" data-column="${i}"></td><td><label for="checkbox${i}" class="label-inline">${column.title}</label></td></tr>`
			}
			if (column.can_duplicate === true) { 
				list_columns_filter_html += `<li class="flex-item-a"><input type="checkbox" id="add_checkbox${i}" class="toggle-lot-param" data-column="${i}"><label for="add_checkbox${i}" class="label-inline">${column.title}</label></li>`
			}
		}
		table_columns_filter.append(columns_filter_html)
		list_columns_filter.append(list_columns_filter_html)		
	}
	initFilters()

	// create empty footer
	let empty_footer = `<tr>${Array(table_columns.length).fill("<th></th>").join('')}</tr>`
	$("#datatable tfoot").append(empty_footer)

	var table = $('#datatable').DataTable({
		paging: false,
		info: false,
		scrollX: true,
        fixedColumns: {
        	leftColumns: 1,
        	rightColumns: 3,
        },
		dom: "lrtip",
		columnDefs: [
       		{"className": "dt-center", "targets": "_all"}
   		],
   		columns: table_columns,
   		ajax: '{% url 'api-producers-sample-lots' %}',
		initComplete: function() {
			// create filter
            this.api().columns().every(function () {
                var column = this;
                let table_column = table_columns[column.index()]
                if (table_column.can_filter === true) {
	                var select = $('<select><option value=""></option></select>')
	                    .appendTo($(column.footer()).empty())
	                    .on('change', function() {
	                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
	                        column.search(val ? '^'+val+'$' : '', true, false).draw();
	                    });
	                column.data().unique().sort().each(function (d, j) {
	                    select.append('<option value="'+d+'">'+d+'</option>')
	                });
	            } else {
	            	$(column.footer()).append(table_column.title)
	            }
            }).draw()
         }
	})

	function loadTableSettings() {
		var tableSettings = localStorage.getItem('tableSettings');
		if (tableSettings === undefined || tableSettings === null) {
			let nb_columns = table.columns().data().length
			columns = Array(nb_columns).fill(1);
			saveTableSettings(columns)
		} else {
			columns = JSON.parse(tableSettings)
		}
		return columns
	}
	
	function loadAddLotSettings() {
		var addLotSettings = localStorage.getItem('addLotSettings');
		if (addLotSettings === undefined || addLotSettings === null) {
			let nb_columns = table.columns().data().length
			columns = Array(nb_columns).fill(1);
			saveAddLotSettings(columns)
		} else {
			columns = JSON.parse(addLotSettings)
		}
		console.log(`Loaded ${columns}`)
		return columns
	}


	function saveTableSettings(settings) {
		localStorage.setItem("tableSettings", JSON.stringify(settings));
	}

	function saveAddLotSettings(settings) {
		console.log(`Saving ${settings}`)
		localStorage.setItem("addLotSettings", JSON.stringify(settings));
	}	

	function showHideTableColumns(columns) {
		/* display table columns depending on config */
		let nb_columns = table.columns().data().length

		for (let i = 0, len = nb_columns; i < len; i++) {
			let isChecked = columns[i]
			let boxid = '#checkbox' + i
			var column = table.column(i)
			if (isChecked) {
				$(boxid).prop("checked", true);
				if (!column.visible()) {
					column.visible(!column.visible()) 
				}
			} else {
				$(boxid).prop("checked", false);
				if (column.visible()) {
					column.visible(!column.visible()) 
				}				
			}
		}
	}

	function preCheckAddLotSettings(columns) {
		/* checks checkboxes according to config */
		let nb_columns = table.columns().data().length
		for (let i = 0, len = nb_columns; i < len; i++) {
			let isChecked = columns[i]
			let boxid = '#add_checkbox' + i
			if (isChecked) {
				$(boxid).prop("checked", true);
			} else {
				$(boxid).prop("checked", false);
			}
		}
	}

	var columnsSettings = loadTableSettings()
	showHideTableColumns(columnsSettings)

	var addLotSettings = loadAddLotSettings()
	preCheckAddLotSettings(addLotSettings)

	/* column filter modal event management */
	$('.toggle-vis').on('click', function(e) {
        // Get the column API object
        let colid = $(this).attr('data-column')
        let column = table.column(colid);

        // Toggle the visibility
        column.visible(!column.visible());
        columnsSettings[colid] = columnsSettings[colid] == 1 ? 0 : 1
        saveTableSettings(columnsSettings)
	});

	/* add lot settings */
	$('.toggle-lot-param').on('click', function(e) {
      	let colid = $(this).attr('data-column')
        let column = table.column(colid);		
        addLotSettings[colid] = addLotSettings[colid] == 1 ? 0 : 1
        saveAddLotSettings(addLotSettings)
	});	

	/* add lot */
	$("#add_lot").on('click', function(e) {
		// take the last row of the table and duplicate it
        let last_row = table.row(':last').data()
        table.row.add(last_row).draw()
	})

	/* import file */
	$("#file_to_upload").on('change', function(e) {
		let reader = new FileReader();
		reader.onload = function(e) {
		    var data = reader.result;
		    var lines = data.split("\n")
		    var line_end = `;Brouillon;--;<input type="checkbox" />`
		    for (let i = 0, len = lines.length; i < len; i++) {
		    	if (i === 0) {
		    		continue
		    	}
		    	if (lines[i].length < 19) {
		    		continue
		    	}
		    	let full_line = lines[i].concat(line_end)
        		table.row.add(full_line.split(";")).draw()
		    }
	    	modal_import.style.display = "none"
		};
		reader.onerror = function(event) {
		    console.error("File could not be read! Code " + event.target.error.code);
		};
		reader.readAsText(e.target.files[0]);
	})

	function display_lot_modal(data) {
        // add data to modal
        console.log(`display modal with data ${data}`)
        for (let i = 0, len = data.length; i < len; i++) {
        	let col_data = data[i]
        	let col_name = colid2colname[i]
        	let destination_element = col2field[col_name]
        	$(`#${destination_element}`).val(col_data)
        }
		// show modal
		modal_lot.style.display = "flex";		
	}

	function show_hide_action_buttons() {
		// buttons Valider & Affilier
		// pseudo code: if all rows are valid, button Affilier is active
		// if one of the rows is a draft, button Valider is active
		let draft_present = false
		let keys = Object.keys(selected_rows)
		for (let i = 0, len = keys.length; i < len; i++) {
			let key = keys[i]
			let rowdata = selected_rows[key]
			let statut = rowdata['statut']
			if (statut.toLowerCase() === "brouillon") {
				draft_present = true
			}
		}
		var btn_affiliate = document.getElementById("btn_affiliate")
		var select_affiliate = document.getElementById("select_affiliate")
		var btn_validate = document.getElementById("btn_validate")
		var btn_delete = document.getElementById("btn_delete")
		if (keys.length > 0 && draft_present === false) {
			// at least one row selected, all valid: set affiliate button to active
			$("#btn_affiliate").addClass('primary')
			$("#btn_affiliate").removeClass('secondary')
			$("#select_affiliate").prop("disabled", false)
		} else {
			$("#btn_affiliate").addClass('secondary')
			$("#btn_affiliate").removeClass('primary')
			$("#select_affiliate").prop("disabled", "disabled")
		}

		if (draft_present === true) {
			$("#btn_validate").addClass('primary')
			$("#btn_validate").removeClass('secondary')		
			$("#btn_delete").addClass('primary')
			$("#btn_delete").removeClass('secondary')		
		} else {
			$("#btn_validate").addClass('secondary')
			$("#btn_validate").removeClass('primary')		
			$("#btn_delete").addClass('secondary')
			$("#btn_delete").removeClass('primary')			
		}

		if (keys.length === 1) {
			// 1 lot selected
			$("#add_lot").text("Dupliquer Lot")
		} else {
			$("#add_lot").text("Ajouter Lot")
		}

	}
	show_hide_action_buttons()
	/* click on datatable row */
	var modal_lot = document.getElementById("modal_lot")
	$('#datatable_wrapper tbody').on('click', 'input', function() {
		let hrow = $(this).closest("tr")
		let row = table.row(hrow)
		let data = table.row(row).data();	
		let rowid = table.row(row).index();
		// add to selection if checked, otherwise remove
		if (rowid in selected_rows) {
			delete selected_rows[rowid]
		} else {
			selected_rows[rowid] = data
		}
		show_hide_action_buttons()
	})

	$('#datatable_wrapper tbody').on('click', 'td', function() {
		// check if we clicked on the checkbox
		let cell = table.cell(this)
		let colid = cell.index()['column']
		let row = $(this).closest('tr');
		let data = table.row(row).data()
		let table_column = table_columns[colid]	
   		if (table_column['data'] === 'checkbox') {
			// ignore clicks on checkbox column
			return
		} else {	
			display_lot_modal(data)
		}
	});

	$("#add_lot_params").on('click', function() {
	    $("#add_lot_params_toggle").toggle();
	});

	$(document).on('change', '#checkbox_header', function() {
    	if (this.checked) {
    		let rows = table.rows()
    		for (let i = 0, len = table.rows().count(); i < len; i++) {
    			$(rows[i]).find('input').prop('checked', true)
    			let row = table.row(i)
				selected_rows[i] = row.data()
			}
      	} else {
    		let rows = table.rows()
    		for (let i = 0, len = table.rows().count(); i < len; i++) {
    			$(rows[i]).find('input').prop('checked', false)
				delete selected_rows[i]
			}      		
		}
		console.log(selected_rows)
		show_hide_action_buttons()
    })

	/* modals */
	// modal for column filters
	var modal_columns = document.getElementById("modal_columns")
	var btn_open = document.getElementById("btn_modal_columns")
	btn_open.onclick = function() {
	  modal_columns.style.display = "flex"
	}

	// modal import
	var modal_import = document.getElementById("modal_import")
	var btn_import_open = document.getElementById("btn_modal_import")
	btn_import_open.onclick = function() {
	  modal_import.style.display = "flex";
	}

	/* modal close events */
	// button
	var btns_close = document.getElementsByClassName("close")
	for (let i = 0, len = btns_close.length; i < len; i++) {
		let btn_close = btns_close[i]
		btn_close.onclick = function() {
		  modal_columns.style.display = "none"
		  modal_import.style.display = "none"
		  modal_lot.style.display = "none"
		}
	}
	// clicking outside of the modal window will close it
	window.onclick = function(event) {
	  if (event.target == modal_columns) {
	    modal_columns.style.display = "none"
	  }
	  if (event.target == modal_import) {
	    modal_import.style.display = "none"
	  }
	  if (event.target == modal_lot) {
	    modal_lot.style.display = "none"
	  }
	}
	// escape key
	$(document).keydown(function(event) {
	  if (event.keyCode == 27) {
	    modal_columns.style.display = "none"
	    modal_import.style.display = "none"
	    modal_lot.style.display = "none"
	  }
	});
});

// fixed column styling on row hover
$(document).on({
	mouseenter: function () {
		trIndex = $(this).index();
		$("#datatable tbody").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").addClass("hover")
		});
		$("table.dataTable.DTFC_Cloned tbody").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").addClass("hover")
		});
	},
	mouseleave: function () {
		trIndex = $(this).index();
		$("#datatable tbody").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").removeClass("hover");
		});
		$("table.dataTable.DTFC_Cloned tbody").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").removeClass("hover");
		});		
	}
}, ".dataTables_wrapper tbody tr");

</script>

{% endblock %}