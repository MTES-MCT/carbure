{% extends "producers/index.html" %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.css"/>
{% endblock %}


{% block producer  %}
<div class="main" style="overflow-x: auto;">
	<div class="panel">
		<h3>Attestation de Durabilité 2019-12</h3>
		<a class="button modal-button" id="btn_modal_columns">Colonnes</a>
		<div class="modal__backdrop" id="modal_columns">
			<div class="modal">
				<table>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox0" class="toggle-vis" data-column="0"></td>
						<td><label for="checkbox0" class="label-inline">Dépôt</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox1" class="toggle-vis" data-column="1"></td>
						<td><label for="checkbox1" class="label-inline">N°DAE ou DAA</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox2" class="toggle-vis" data-column="2"></td>
						<td><label for="checkbox2" class="label-inline">Date d'entrée</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox3" class="toggle-vis" data-column="3"></td>
						<td><label for="checkbox3" class="label-inline">Volume</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox4" class="toggle-vis" data-column="4"></td>
						<td><label for="checkbox4" class="label-inline">Types</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox5" class="toggle-vis" data-column="5"></td>
						<td><label for="checkbox5" class="label-inline">Filière de production</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox6" class="toggle-vis" data-column="6"></td>
						<td><label for="checkbox6" class="label-inline">Catégorie</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox7" class="toggle-vis" data-column="7"></td>
						<td><label for="checkbox7" class="label-inline">Système fournisseur</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox8" class="toggle-vis" data-column="8"></td>
						<td><label for="checkbox8" class="label-inline">Pays d'origine</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox9" class="toggle-vis" data-column="9"></td>
						<td><label for="checkbox9" class="label-inline">Respect des critères de durabilité</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox10" class="toggle-vis" data-column="10"></td>
						<td><label for="checkbox10" class="label-inline">GES transport et distribution</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox11" class="toggle-vis" data-column="11"></td>
						<td><label for="checkbox11" class="label-inline">Total émissions GES</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox12" class="toggle-vis" data-column="12"></td>
						<td><label for="checkbox12" class="label-inline">GES carburant fossile</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox13" class="toggle-vis" data-column="13"></td>
						<td><label for="checkbox13" class="label-inline">% de réduction totale</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox14" class="toggle-vis" data-column="14"></td>
						<td><label for="checkbox14" class="label-inline">Numéro d'enregistrement double-comptage</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox15" class="toggle-vis" data-column="15"></td>
						<td><label for="checkbox15" class="label-inline">Pays d'implantation</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox16" class="toggle-vis" data-column="16"></td>
						<td><label for="checkbox16" class="label-inline">Date de mise en service</label></td>
					</tr>
				</table>
				<div class="form__group button__group">
					<a class="button secondary close">Ok</a>
				</div>
			</div>
		</div>
		<a class="button modal-button" id="btn_modal_import">Import</a>
		<div class="modal__backdrop" id="modal_import">
			<div class="modal">
				<a href="/static/files/template.csv">Template</a>
				<input type="file" name="fileToUpload" id="fileToUpload">
				<div class="form__group button__group">
					<a class="button secondary close" href="#">Cancel</a>
					<a class="button primary close" href="#">Ok</a>
				</div>
			</div>
		</div>
		<table class="display nowrap" id="datatable">
			<thead>
				<tr>
					<th>Dépôt</th>
					<th>N°DAE ou DAA</th>
					<th>Date d'entrée</th>
					<th>Volume</th>
					<th>Types</th>
					<th>Filière de production</th>
					<th>Catégorie</th>
					<th>Système fournisseur</th>
					<th>Pays d'origine</th>
					<th>Respect des critères de durabilité</th>
					<th>GES transport et distribution</th>
					<th>Total émissions de GES</th>
					<th>GES du carburant fossile</th>
					<th>% de réduction totale</th>
					<th>Numéro d'enregistrement double-comptage</th>
					<th>Pays d'implantation</th>
					<th>Date de mise en service</th>
					<th>Status du Lot</th>
					<th>Affiliation</th>
					<th>Sélectionner</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>GRANDPUITS</td>
					<td>19FRG0432000482724020</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Validé</td>
					<td>SAIPOL</td>
					<td><input type="checkbox" /></td>
				</tr>
				<tr>
					<td>GRANDPUITS</td>
					<td>19FRG0432000482724020</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Validé</td>
					<td>--</td>
					<td><input type="checkbox" /></td>
				</tr>	
				<tr>
					<td>GRANDPUITS</td>
					<td>19FRG0432000482724020</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Validé</td>
					<td>--</td>
					<td><input type="checkbox" /></td>
				</tr>							
				<tr>
					<td>GRANDPUITS</td>
					<td>19FRG0432000482724020</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Brouillon</td>
					<td>--</td>					
					<td><input type="checkbox" /></td>
				</tr>
				<tr>
					<td>GRANDPUITS</td>
					<td>19FRG0432000482724020</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Validé</td>
					<td>Export</td>					
					<td><input type="checkbox" /></td>
				</tr>
			</tbody>
		</table>
		<div class="flex-container-left">
			<a class="button primary" href="#" id="add_lot">Ajouter Lot</a>
		</div>
		<div class="flex-container-right">
			<select>
			 	<option value="none">--</option>
			  	<option value="total">Total</option>
			  	<option value="saipol">Saipol</option>
			  	<option value="petrobras">Petrobras</option>
			  	<option value="bp">BP</option>
			  	<option value="repsol">Repsol</option>
			  	<option value="export">Export</option>
			</select>
			<a class="button primary" href="#">Affilier Lots</a>
			<a class="button warning-light" href="#">Valider Lots</a>
		</div>
	</div>
</div>

<div class="modal__backdrop" id="modal_lot">
	<div class="modal modal-big">
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Informations Générales</h2>
					<label for="ml_depot">Dépôt</label>
					<input type="text" value="" id="ml_depot">
					<label for="ml_dae">N°DAE ou DAA</label>
					<input type="text" value="" id="ml_dae">
					<label for="ml_volume">Volume</label>
					<input type="text" value="" id="ml_volume">
					<label for="ml_date_entree">Date d'entrée en EFS ou UER</label>
					<input type="text" value="" id="ml_date_entree">
					<label for="ml_pays">Pays d'implantation</label>
					<input type="text" value="" id="ml_pays">
					<label for="ml_date_mise_en_service">Date de mise en service</label>
					<input type="text" value="" id="ml_date_mise_en_service">
				</div>
			</div>
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Durabilité</h2>
					<label for="ml_filiere">Filière de production</label>
					<select id="ml_filiere">
						<option>Choisissez...</option>
						<option>Colza</option>
						<option>Maïs</option>
						<option>Navet</option>
						<option>Fenouil</option>
					</select>
					<label for="ml_type">Types</label>
					<input type="text" value="" id="ml_type">
					<label for="ml_cat">Catégorie</label>
					<input type="text" value="" id="ml_cat">
					<label for="ml_systeme_fournisseur">Système fournisseur</label>
					<input type="text" value="" id="ml_systeme_fournisseur">
					<label for="ml_pays_origine">Pays d'origine</label>
					<input type="text" value="" id="ml_pays_origine">
					<label for="ml_respect_crit_durabilite">Respect des critères de durabilité</label>
					<input type="text" value="" id="ml_respect_crit_durabilite">
					<label for="ml_num_double_comptage">Numéro d'enregistrement double-comptage</label>
					<input type="text" value="" id="ml_num_double_comptage">
				</div>
			</div>
		</section>
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Émissions GES</h2>
					<table>
						<thead>
							<th>GES transport et distribution</th>
							<th>Total émissions de GES</th>
							<th>GES du carburant fossile</th>
							<th>% de réduction totale</th>
						</thead>
						<tbody>
							<td><input type="text" id="ml_ges_transport_distribution" /></td>
							<td><input type="text" id="ml_ges_total" /></td>
							<td><input type="text" id="ml_ges_fossile" /></td>
							<td><input type="text" id="ml_ges_reduction" /></td>
						</tbody>
					</table>
				</div>
			</div>
		</section>
		<section class="flex-container">
			<div class="flex-container-left">
				<div class="form__group">
					<h2>Affiliation</h2>
					<table>
						<thead>
							<th>Date</th>
							<th>Vendeur</th>
							<th>Acheteur</th>
						</thead>
						<tbody>
							<td><input type="text" id="ml_date_affiliation" value="27/01/2020"/></td>
							<td><input type="text" id="ml_vendeur" value="BioRaffinerie Lambda"/></td>
							<td><input type="text" id="ml_acheteur" value="SAIPOL"/></td>
						</tbody>
					</table>
				</div>
			</div>
		</section>		
		<section class="flex-container-right">
			<div class="form__group button__group">
				<a class="button secondary close" href="#">Ok</a>
			</div>
		</section>
	</div>
</div>

{% endblock %}


{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.js"></script>
<script type="text/javascript">
var col2field = {0: 'ml_depot', 1: 'ml_dae', 2: 'ml_date_entree', 3: 'ml_volume', 4: 'ml_type', 5:'ml_filiere', 6:'ml_cat',
7: 'ml_systeme_fournisseur', 8:'ml_pays_origine', 9:'ml_respect_crit_durabilite', 10:'ml_ges_transport_distribution',
11: 'ml_ges_total', 12:'ml_ges_fossile', 13:'ml_ges_reduction', 14:'ml_num_double_comptage', 15:'ml_pays', 16:'ml_date_mise_en_service', 17: 'ml_status', 18: 'ml_affiliation', 19:'ml_select'}

$(document).ready(function() {
	var table = $('#datatable').DataTable({
		paging: false,
		scrollX: true,
		searching: false,
		autoWidth: false,
		scrollCollapse: true,
		fixedColumns: {
			leftColumns: 1,
			rightColumns: 3,
		},
		initComplete: function() {
        	this.api().columns().every(function () {
                var column = this;
                var select = $('<select><option value=""></option></select>')
                    .appendTo($(column.footer()).empty())
                    .on('change', function() {
                        var val = $.fn.dataTable.util.escapeRegex($(this).val());
                        column.search(val ? '^'+val+'$' : '', true, false).draw();
                    });
                column.data().unique().sort().each(function(d, j) {
                    select.append('<option value="'+d+'">'+d+'</option>')
                });
        	});
    	}
	});

	function loadTableSettings() {
		var tableSettings = localStorage.getItem('tableSettings');
		if (tableSettings === undefined || tableSettings === null) {
			let nb_columns = table.columns().data().length
			columns = Array(nb_columns).fill(1);
			saveTableSettings(columns)
		} else {
			columns = JSON.parse(tableSettings)
		}
		console.log(`table settings ${columns}`)
		return columns
	}


	function saveTableSettings(settings) {
		localStorage.setItem("tableSettings", JSON.stringify(settings));
	}

	function showHideTableColumns(columns) {
		/* display table columns depending on config */
		let frozen_columns = [0, 17, 18, 19] // first column (depot) and last (selection) cannot be hidden
		let nb_columns = table.columns().data().length

		for (let i = 0, len = nb_columns; i < len; i++) {
			let isChecked = columns[i]
			let boxid = '#checkbox' + i
			var column = table.column(i)
			if (isChecked || frozen_columns.includes(i)) {
				$(boxid).prop("checked", true);
				if (!column.visible()) {
					column.visible(!column.visible()) 
				}
			} else {
				$(boxid).prop("checked", false);
				if (column.visible()) {
					column.visible(!column.visible()) 
				}				
			}
		}
	}

	var columnsSettings = loadTableSettings()
	console.log(`col settings: ${columnsSettings}`)
	showHideTableColumns(columnsSettings)

	/* column filter modal event management */
	$('.toggle-vis').on('click', function(e) {
        // Get the column API object
        let colid = $(this).attr('data-column')
        let column = table.column(colid);

        // Toggle the visibility
        column.visible(!column.visible());
        columnsSettings[colid] = columnsSettings[colid] == 1 ? 0 : 1
        saveTableSettings(columnsSettings)
	});

	/* add lot */
	$("#add_lot").on('click', function(e) {
		// take the last row of the table and duplicate it
        let last_row = table.row(':last').data()
        table.row.add(last_row).draw()
	})

	/* click on datatable row */
	var modal_lot = document.getElementById("modal_lot")
	$('#datatable tbody').on('click', 'tr', function() {
        var data = table.row(this).data();
        // add data to modal
        for (let i = 0, len = data.length; i < len; i++) {
        	let col_data = data[i]
        	let destination_element = col2field[i]
        	$(`#${destination_element}`).val(col_data)
        }
		// show modal
		modal_lot.style.display = "flex";

	});

	/* modals */
	// modal for column filters
	var modal_columns = document.getElementById("modal_columns")
	var btn_open = document.getElementById("btn_modal_columns")
	btn_open.onclick = function() {
	  modal_columns.style.display = "flex"
	}

	// modal import
	var modal_import = document.getElementById("modal_import")
	var btn_import_open = document.getElementById("btn_modal_import")
	btn_import_open.onclick = function() {
	  modal_import.style.display = "flex";
	}

	/* modal close events */
	// button
	var btns_close = document.getElementsByClassName("close")
	for (let i = 0, len = btns_close.length; i < len; i++) {
		let btn_close = btns_close[i]
		console.log(`${btn_close}`)
		btn_close.onclick = function() {
		  console.log(`btn close clicked`)
		  modal_columns.style.display = "none"
		  modal_import.style.display = "none"
		  modal_lot.style.display = "none"
		}
	}
	// click outside of the modal window
	window.onclick = function(event) {
	  if (event.target == modal_columns) {
	    modal_columns.style.display = "none"
	  }
	  if (event.target == modal_import) {
	    modal_import.style.display = "none"
	  }
	  if (event.target == modal_lot) {
	    modal_lot.style.display = "none"
	  }
	}
	// escape key
	$(document).keydown(function(event) {
	  if (event.keyCode == 27) {
	    modal_columns.style.display = "none"
	    modal_import.style.display = "none"
	    modal_lot.style.display = "none"
	  }
	});
});
</script>

{% endblock %}