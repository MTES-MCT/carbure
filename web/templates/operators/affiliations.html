{% extends "operators/index.html" %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.css"/>
{% endblock %}


{% block operator  %}
<div class="main" style="overflow-x: auto;">
	<div class="panel">
		<h3>Lots Affiliés</h3>
		<a class="button modal-button" id="btn_modal_columns">Filtrer</a>
		<div class="modal__backdrop" id="modal_columns">
			<div class="modal">
				<table>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox0" class="toggle-vis" data-column="0"></td>
						<td><label for="checkbox0" class="label-inline">N°DAE ou DAA</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox1" class="toggle-vis" data-column="1"></td>
						<td><label for="checkbox1" class="label-inline">Dépôt</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox2" class="toggle-vis" data-column="2"></td>
						<td><label for="checkbox2" class="label-inline">Date d'entrée</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox3" class="toggle-vis" data-column="3"></td>
						<td><label for="checkbox3" class="label-inline">Volume</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox4" class="toggle-vis" data-column="4"></td>
						<td><label for="checkbox4" class="label-inline">Types</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox5" class="toggle-vis" data-column="5"></td>
						<td><label for="checkbox5" class="label-inline">Filière de production</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox6" class="toggle-vis" data-column="6"></td>
						<td><label for="checkbox6" class="label-inline">Catégorie</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox7" class="toggle-vis" data-column="7"></td>
						<td><label for="checkbox7" class="label-inline">Système fournisseur</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox8" class="toggle-vis" data-column="8"></td>
						<td><label for="checkbox8" class="label-inline">Pays d'origine</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox9" class="toggle-vis" data-column="9"></td>
						<td><label for="checkbox9" class="label-inline">Respect des critères de durabilité</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox10" class="toggle-vis" data-column="10"></td>
						<td><label for="checkbox10" class="label-inline">GES transport et distribution</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox11" class="toggle-vis" data-column="11"></td>
						<td><label for="checkbox11" class="label-inline">Total émissions GES</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox12" class="toggle-vis" data-column="12"></td>
						<td><label for="checkbox12" class="label-inline">GES carburant fossile</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox13" class="toggle-vis" data-column="13"></td>
						<td><label for="checkbox13" class="label-inline">% de réduction totale</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox14" class="toggle-vis" data-column="14"></td>
						<td><label for="checkbox14" class="label-inline">Éligible double-comptage</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox15" class="toggle-vis" data-column="15"></td>
						<td><label for="checkbox15" class="label-inline">Pays d'implantation</label></td>
					</tr>
					<tr>
						<td><input type="checkbox" name="checkbox" id="checkbox16" class="toggle-vis" data-column="16"></td>
						<td><label for="checkbox16" class="label-inline">Date de mise en service</label></td>
					</tr>
				</table>
				<div class="form__group button__group">
					<a class="button secondary close">Ok</a>
				</div>
			</div>
		</div>

		<table class="display nowrap" id="datatable">
			<thead>
				<tr>
					<th>N°DAE ou DAA</th>
					<th>Dépôt</th>
					<th>Date d'entrée</th>
					<th>Volume</th>
					<th>Types</th>
					<th>Filière de production</th>
					<th>Catégorie</th>
					<th>Système fournisseur</th>
					<th>Pays d'origine</th>
					<th>Respect des critères de durabilité</th>
					<th>GES transport et distribution</th>
					<th>Total émissions de GES</th>
					<th>GES du carburant fossile</th>
					<th>% de réduction totale</th>
					<th>Éligible double-comptage</th>
					<th>Pays d'implantation</th>
					<th>Date de mise en service</th>
					<th>Vendeur</th>
					<th><input type="checkbox" id="checkbox_select_all"/></th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>19FRG0432000482724020</td>
					<td>GRANDPUITS</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>SAIPOL</td>
					<td><input type="checkbox" /></td>
				</tr>
				<tr>
					<td>19FRG0432000482724020</td>
					<td>GRANDPUITS</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Total</td>
					<td><input type="checkbox" /></td>
				</tr>	
				<tr>
					<td>19FRG0432000482724020</td>
					<td>GRANDPUITS</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>Total</td>
					<td><input type="checkbox" /></td>
				</tr>							
				<tr>
					<td>19FRG0432000482724020</td>
					<td>GRANDPUITS</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>SAIPOL</td>					
					<td><input type="checkbox" /></td>
				</tr>
				<tr>
					<td>19FRG0432000482724020</td>
					<td>GRANDPUITS</td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>CONV</td>
					<td>SV-2BS010010</td>
					<td>FR</td>
					<td>Oui</td>
					<td>1.00</td>
					<td>34.12</td>
					<td>83.80</td>
					<td>59.28%</td>
					<td>N/A</td>
					<td>FR</td>
					<td>1/7/2007</td>
					<td>SAIPOL</td>					
					<td><input type="checkbox" /></td>
				</tr>
			</tbody>
		</table>

		<div class="flex-container-right">
			<a class="button secondary" href="#" id="btn_accept">Accepter Lots</a>
			<a class="button secondary" href="#" id="btn_reject">Refuser Lots</a>
		</div>			
	</div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.js"></script>
<script type="text/javascript">
var colname2colid = {'DAE_COLID': 0, 'DEPOT_COLID': 1, 'DATE_ENTREE_COLID': 2, 'VOLUME_COLID': 3, 'TYPE_COLID': 4, 'FILIERE_COLID': 5, 'CATEGORY_COLID': 6,
'SYSTEME_FOURNISSEUR_COLID': 7, 'PAYS_ORIGINE_COLID': 8, 'RESPECT_CRIT_DURABILITE_COLID': 9, 'GES_TRANSPORT_COLID': 10, 'GES_TOTAL_COLID': 11,
'GES_FOSSILE_COLID': 12, 'GES_REDUCTION_COLID': 13, 'NUM_DOUBLE_COMPTAGE_COLID': 14, 'PAYS_COLID': 15, 'DATE_MISE_EN_SERVICE_COLID': 16, 
'AFFILIATION_COLID': 17, 'SELECT_CHECKBOX_COLID': 18}

var colid2colname = {}
Object.keys(colname2colid).forEach(key => { colid2colname[colname2colid[key]] = key });

var selected_rows = {}

$(document).ready(function() {
	var table = $('#datatable').DataTable({
		paging: false,
		info: false,
		scrollX: true,
		searching: false,
		autoWidth: false,
		scrollCollapse: true,
        fixedColumns: {
            rightColumns: 2,
        },
		columnDefs: [
      		{"className": "dt-center", "targets": "_all"}
   		],		        
	});

	/* filters  */
	function loadTableSettings() {
		var tableSettings = localStorage.getItem('affiliationTableSettings');
		if (tableSettings === undefined || tableSettings === null) {
			let nb_columns = table.columns().data().length
			columns = Array(nb_columns).fill(1);
			saveTableSettings(columns)
		} else {
			columns = JSON.parse(tableSettings)
		}
		return columns
	}

	function saveTableSettings(settings) {
		localStorage.setItem("affiliationTableSettings", JSON.stringify(settings));
	}


	function showHideTableColumns(columns) {
		/* display table columns depending on config */
		let frozen_columns = [colname2colid['AFFILIATION_COLID'], colname2colid['SELECT_CHECKBOX_COLID']] // first column (DAE) and last 2 (affiliation, selection) cannot be hidden
		let nb_columns = table.columns().data().length
		for (let i = 0, len = nb_columns; i < len; i++) {
			let isChecked = columns[i]
			let boxid = '#checkbox' + i
			var column = table.column(i)
			if (isChecked || frozen_columns.includes(i)) {
				$(boxid).prop("checked", true);
				if (!column.visible()) {
					column.visible(!column.visible()) 
				}
			} else {
				$(boxid).prop("checked", false);
				if (column.visible()) {
					column.visible(!column.visible()) 
				}				
			}
		}
	}

	var columnsSettings = loadTableSettings()
	showHideTableColumns(columnsSettings)	

	/* column filter modal event management */
	$('.toggle-vis').on('click', function(e) {
        // Get the column API object
        let colid = $(this).attr('data-column')
        let column = table.column(colid);

        // Toggle the visibility
        column.visible(!column.visible());
        columnsSettings[colid] = columnsSettings[colid] == 1 ? 0 : 1
        saveTableSettings(columnsSettings)
	});

	function show_hide_action_buttons() {
		// buttons Accepter & Refuser
		let keys = Object.keys(selected_rows)
		var btn_affiliate = document.getElementById("btn_affiliate")
		var select_affiliate = document.getElementById("select_affiliate")
		var btn_validate = document.getElementById("btn_validate")
		if (keys.length > 0) {
			// at least one row selected, activate buttons
			$("#btn_accept").addClass('primary')
			$("#btn_accept").removeClass('secondary')		
			$("#btn_reject").addClass('primary')
			$("#btn_reject").removeClass('secondary')					
		} else {
			$("#btn_accept").removeClass('primary')
			$("#btn_accept").addClass('secondary')		
			$("#btn_reject").removeClass('primary')
			$("#btn_reject").addClass('secondary')				
		}
	}

	/* click on datatable row */
	// click the checkbox
	$('#datatable_wrapper tbody').on('click', 'input', function() {
		let hrow = $(this).closest("tr")
		let row = table.row(hrow)
		let data = table.row(row).data();	
		let rowid = table.row(row).index();
		// add to selection if checked, otherwise remove
		if (rowid in selected_rows) {
			delete selected_rows[rowid]
		} else {
			selected_rows[rowid] = data
		}
		show_hide_action_buttons()
	})
	// click anywhere else: show modal
	$('#datatable_wrapper tbody').on('click', 'td', function() {
		// check if we clicked on the checkbox
		let cell = table.cell(this)
		let colid = cell.index()['column']
		let row = $(this).closest('tr');
		let data = table.row(row).data();
   		if (colid == colname2colid['SELECT_CHECKBOX_COLID']) {
			// ignore clicks on checkbox column
			return
		} else {	
			window.location = "{% url 'operators-lot' %}"
		}
	});

	$(document).on('change', '#checkbox_select_all', function() {
    	if (this.checked) {
    		let rows = table.rows()
    		for (let i = 0, len = table.rows().count(); i < len; i++) {
    			$(rows[i]).find('input').prop('checked', true)
    			let row = table.row(i)
				selected_rows[i] = row.data()
			}
      	} else {
    		let rows = table.rows()
    		for (let i = 0, len = table.rows().count(); i < len; i++) {
    			$(rows[i]).find('input').prop('checked', false)
				delete selected_rows[i]
			}      		
		}
		show_hide_action_buttons()
    })

	var modal_columns = document.getElementById("modal_columns")
	var btn_open = document.getElementById("btn_modal_columns")
	btn_open.onclick = function() {
	  modal_columns.style.display = "flex"
	}

	/* modal close events */
	// button
	var btns_close = document.getElementsByClassName("close")
	for (let i = 0, len = btns_close.length; i < len; i++) {
		let btn_close = btns_close[i]
		btn_close.onclick = function() {
		  modal_columns.style.display = "none"
		}
	}
	// clicking outside of the modal window will close it
	window.onclick = function(event) {
	  if (event.target == modal_columns) {
	    modal_columns.style.display = "none"
	  }
	}
	// escape key
	$(document).keydown(function(event) {
	  if (event.keyCode == 27) {
	    modal_columns.style.display = "none"
	  }
	});

});

// fixed column styling on row hover for fixed columns
$(document).on({
	mouseenter: function () {
		trIndex = $(this).index()+1;
		$("table.dataTable").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").each(function(index) {
				$(this).addClass("hover");
			});
		});
	},
	mouseleave: function () {
		trIndex = $(this).index()+1;
		$("table.dataTable").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").each(function(index) {
				$(this).removeClass("hover");
			});
		});
	}
}, ".dataTables_wrapper tr");

</script>

{% endblock %}