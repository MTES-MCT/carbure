{% extends "operators/index.html" %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.css"/>
{% endblock %}


{% block operator  %}
<div class="main" style="overflow-x: auto;">
	<div class="panel">
		<h3>Mes Corrections</h3>
		<table class="display nowrap" id="datatable">
			<thead>
				<tr>
					<th>Provenance</th>
					<th>N°DAE ou DAA</th>
					<th>Date d'entrée</th>
					<th>Volume</th>
					<th>Types</th>
					<th>Filière de production</th>
					<th>Pays d'origine</th>
					<th>Statut</th>
					<th>Commentaire initial</th>
					<th>Sélectionner</th>
				</tr>
			</thead>
			<tbody>
				<tr class="status_warning">
					<td>OperateurGamma</td>
					<td><a href="{% url 'operators-lot' %}">19FRG0432000482724020</a></td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>FR</td>
					<td>En attente</td>
					<td>Bonjour, GES Total correct ?</td>
					<td><input type="checkbox" /></td>
				</tr>
				<tr class="status_warning">
					<td>OperateurGamma</td>
					<td><a href="{% url 'operators-lot' %}">19FRG0432000482724020</a></td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>MY</td>
					<td>En attente</td>
					<td>Colza de Malaysie???</td>
					<td><input type="checkbox" /></td>
				</tr>
				<tr>
					<td>OperateurGamma</td>
					<td><a href="{% url 'operators-lot' %}">19FRG0432000482724020</a></td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>FR</td>
					<td>Corrigé</td>
					<td>Volume incorrect</td>
					<td><input type="checkbox" /></td>
				</tr>
				<tr class="status_ok">
					<td>OperateurGamma</td>
					<td><a href="{% url 'operators-lot' %}">19FRG0432000482724020</a></td>
					<td>1/10/2019</td>
					<td>28,687</td>
					<td>EMHV</td>
					<td>Colza</td>
					<td>FR</td>
					<td>Correction Validée</td>
					<td>Pays origine incorrect</td>
					<td><input type="checkbox" disabled="disabled" /></td>
				</tr>
			</tbody>			
		</table>
		<div class="flex-container-right">
			<a class="button secondary" href="#" id="btn_accept">Valider Correction & Accepter Lots</a>
		</div>					
	</div>
</div>
{% endblock %}


{% block extra_js %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.20/fc-3.3.0/datatables.min.js"></script>
<script type="text/javascript">
var colname2colid = {'VENDEUR_COLID': 0, 'DAE_COLID': 1, 'DATE_ENTREE_COLID': 2, 'VOLUME_COLID': 3, 'TYPE_COLID': 4, 'FILIERE_COLID': 5, 'PAYS_ORIGINE_COLID': 6, 'STATUT_COLID': 7, 'COMMENTAIRE_COLID': 8, 'SELECT_CHECKBOX_COLID': 9}

var selected_rows = {}

$(document).ready(function() {
	var table = $('#datatable').DataTable({
		paging: false,
		info: false,
		scrollX: true,
		searching: false,
		ordering: false,
		autoWidth: false,
		scrollCollapse: true,
		columnDefs: [
      		{"className": "dt-center", "targets": "_all"}
   		],		
	});

	function correction_details(d) {
	    // `d` is the original data object for the row
	    return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
	        '<tr>'+
	            '<td>Message Opérateur:</td>'+
	            '<td>'+d.message_operateur+'</td>'+
	        '</tr>'+
	        '<tr>'+
	            '<td>Message Producteur:</td>'+
	            '<td>'+d.message_producteur+'</td>'+
	        '</tr>'+
	    '</table>';
	}
 
	function show_hide_action_buttons() {
		// buttons Accepter & Refuser
		let keys = Object.keys(selected_rows)
		var btn_accept = document.getElementById("btn_accept")
		if (keys.length > 0) {
			// at least one row selected, activate buttons
			$("#btn_accept").addClass('primary')
			$("#btn_accept").removeClass('secondary')		
		} else {
			$("#btn_accept").removeClass('primary')
			$("#btn_accept").addClass('secondary')
		}
	}

	/* click on datatable row */
	// click the checkbox
	$('#datatable_wrapper tbody').on('click', 'input', function() {
		let hrow = $(this).closest("tr")
		let row = table.row(hrow)
		let data = table.row(row).data();	
		let rowid = table.row(row).index();
		// add to selection if checked, otherwise remove
		if (rowid in selected_rows) {
			delete selected_rows[rowid]
		} else {
			selected_rows[rowid] = data
		}
		show_hide_action_buttons()
	})


	$('#datatable_wrapper tbody').on('click', 'td', function() {
		let tr = $(this).closest('tr');
        var row = table.row(tr); 

		let cell = table.cell(this)
		let colid = cell.index()['column']
   		if (colid == colname2colid['SELECT_CHECKBOX_COLID'] || colid == colname2colid['DAE_COLID']) {
			// ignore clicks on checkbox column and DAE 
			return
		}
        if (row.child.isShown()) {
            // This row is already open - close it
            row.child.hide();
            tr.removeClass('shown');
        }
        else {
            // Open this row
            row.child(correction_details({message_operateur: 'Message operateur question?', message_producteur: 'Message producteur reponse'})).show();
            tr.addClass('shown');
        }
	});
});

// fixed column styling on row hover
$(document).on({
	mouseenter: function () {
		trIndex = $(this).index()+1;
		$("table.dataTable").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").each(function(index) {
				$(this).addClass("hover");
			});
		});
	},
	mouseleave: function () {
		trIndex = $(this).index()+1;
		$("table.dataTable").each(function(index) {
			$(this).find("tr:eq("+trIndex+")").each(function(index) {
				$(this).removeClass("hover");
			});
		});
	}
}, ".dataTables_wrapper tr");

</script>

{% endblock %}